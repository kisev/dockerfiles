---
stages:
  - lint
  - build-1
  - build-2

default:
  interruptible: true

.kaniko:
  image:
    name: gcr.io/kaniko-project/executor:v1.8.1-debug
    entrypoint: [ "" ]
  script:
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"username\":\"${CI_REGISTRY_USER}\",\"password\":\"${CI_REGISTRY_PASSWORD}\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --cache=true
      ${KANIKO_EXTRA_ARGS}

.golang:
  resource_group: golang-${GOLANG_VERSION}
  variables:
    KANIKO_EXTRA_ARGS: |
      --context golang
      --dockerfile golang/Dockerfile
      --destination ${CI_REGISTRY_IMAGE}/golang-${GOLANG_VERSION}:${CI_COMMIT_REF_SLUG}
      --build-arg PARENT_TAG=${CI_COMMIT_REF_SLUG}

github-superliner/lint:
  stage: lint
  image:
    name: github/super-linter:slim-v4
    entrypoint: [ "" ]
  variables:
    RUN_LOCAL: "true"
    IGNORE_GITIGNORED_FILES: "true"
    DEFAULT_WORKSPACE: ${CI_PROJECT_DIR}
    ANSIBLE_DIRECTORY: ${CI_PROJECT_DIR}
    LINTER_RULES_PATH: ${CI_PROJECT_DIR}
  script:
    - /action/lib/linter.sh
  artifacts:
    untracked: true

core/build:
  stage: build-1
  extends:
    - .kaniko
  resource_group: core
  variables:
    KANIKO_EXTRA_ARGS: |
      --context core
      --dockerfile core/Dockerfile
      --destination ${CI_REGISTRY_IMAGE}/core:${CI_COMMIT_REF_SLUG}

golang-1.17/build:
  stage: build-2
  extends:
    - .kaniko
    - .golang
  variables:
    GOLANG_VERSION: "1.17"

golang-1.18/build:
  stage: build-2
  extends:
    - .kaniko
    - .golang
  variables:
    GOLANG_VERSION: "1.18"
